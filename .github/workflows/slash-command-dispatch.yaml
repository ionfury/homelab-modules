---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Slash Command Dispatch
on:
  issue_comment:
    types: [created]
jobs:
  slashCommandDispatch:
    runs-on: ubuntu-latest
    permissions:
      actions: write # Allow create workflow dispatch events
      pull-requests: write  # For doing the emoji reaction on a PR comment
      issues: write  # For doing the emoji reaction on an issue comment
      contents: write  # For executing the repository_dispatch event
    steps:
      - uses: xt0rted/pull-request-comment-branch@v3
        id: comment-branch

      - name: Create “test-modules” Check Run
        id: new-check
        uses: marketplace-actions/github-checks@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: test-modules
          sha: ${{ steps.comment-branch.outputs.head_sha }}
          status: in_progress

      - name: Slash Command Dispatch
        id: scd
        uses: peter-evans/slash-command-dispatch@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # https://github.com/peter-evans/slash-command-dispatch/issues/147
          permission: admin
          commands: |
            test
          dispatch-type: workflow
          static-args: |
            head_ref=${{ steps.comment-branch.outputs.head_ref }}
            base_ref=${{ steps.comment-branch.outputs.base_ref }}
            head_sha=${{ steps.comment-branch.outputs.head_sha }}
            check_id=${{ steps.new-check.outputs.check_id }}

      - name: Edit comment with error message
        if: steps.scd.outputs.error-message
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          body: |
            > ${{ steps.scd.outputs.error-message }}