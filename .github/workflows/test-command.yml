---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Tofu Test

on:
  workflow_dispatch:
#  repository_dispatch:
#    types: [test-command]
        
jobs:
  changed-modules:
    runs-on: ubuntu-latest
    outputs:
      modules:  ${{ steps.detect.outputs.modules }}
    steps:
      - name: Get target branch name
        id: vars
        run: |
          branch=${{ github.event.client_payload.slash_command.args.named.branch }}
          if [[ -z "$branch" ]]; then branch="main"; fi
          echo "branch=$branch" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          ref: ${{ steps.vars.outputs.branch }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Detect changed modules
        id: detect
        run: |
          MODULES=$(git diff --name-only origin/${{ steps.pr.outputs.base_ref }}...HEAD \
            | grep '^modules/' \
            | cut -d/ -f2 \
            | sort -u \
            | jq -R -s -c 'split("\n")[:-1]')
          echo "modules=$MODULES" >> $GITHUB_OUTPUT

  test-modules:
    needs: changed-modules
    if: ${{ needs.changed-modules.outputs.modules != '[]' }}
    runs-on: homelab-modules-runner-app
    strategy:
      matrix:
        module: ${{ fromJson(needs.changed-modules.outputs.modules) }}
    steps:
      - name: Get target branch name
        id: vars
        run: |
          branch=${{ github.event.client_payload.slash_command.args.named.branch }}
          if [[ -z "$branch" ]]; then branch="main"; fi
          echo "branch=$branch" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          ref: ${{ steps.vars.outputs.branch }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Check Tofu Version
        run: tofu --version

      - name: Tofu Init
        run: tofu -chdir=modules/${{ matrix.module }} init

      - name: Tofu Plan Tests
        run: tofu -chdir=modules/${{ matrix.module }} test -filter=tests/plan.tftest.hcl

      - name: Tofu Apply Tests
        run: tofu -chdir=modules/${{ matrix.module }} test -filter=tests/apply.tftest.hcl

      - name: Tofu Integration Tests
        run: tofu -chdir=modules/${{ matrix.module }} test -filter=tests/integration.tftest.hcl

  completed:
    runs-on: ubuntu-latest
    name: Add reaction
    needs: [test-modules]
    if: always()
    steps:
      - name: Add reaction
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          reactions: hooray