name: Talos Maintenance Mode Test

on:
  workflow_dispatch:

jobs:
  talosctl-maintenance:
    runs-on: homelab-modules-runner-app
    steps:
      - name: Setup Taskfile
        uses: Illbjorn/setup-task@0.1.0
        
      - name: Setup Tofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.8.8'

      - name: Tofu Test
        run: |
          task tofu:test_kubevirt-talos-hosts_main

      - name: Install talosctl
        run: |
          mkdir -p /home/runner/_work/tools
          curl -sL https://github.com/siderolabs/talos/releases/latest/download/talosctl-linux-amd64 \
            -o /home/runner/_work/tools/talosctl
          chmod +x /home/runner/_work/tools/talosctl

      - name: Test Talos node in maintenance mode (insecure)
        run: |
          /home/runner/_work/tools/talosctl \
            -n talos-cp01-service.default.svc.cluster.local \
            get disks --insecure
