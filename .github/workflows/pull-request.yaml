---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Pull Request CI

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  prepare:
    name: Get Changed Files
    runs-on: ubuntu-latest
    outputs:
      changed-containers: ${{ steps.changed-containers.outputs.changed_files }}
      changed-modules: ${{ steps.changed-modules.outputs.changed_files }}
    steps:
      - name: Get changed containers
        id: changed-containers
        uses: bjw-s-labs/action-changed-files@v0.3.3
        with:
          path: .github/containers
          include_only_directories: true
          max_depth: 1

      - name: Get changed modules
        id: changed-modules
        uses: bjw-s-labs/action-changed-files@v0.3.3
        with:
          path: modules
          include_only_directories: true
          max_depth: 1
          include_deleted_files: true

  build:
    if: ${{ needs.prepare.outputs.changed-containers != '[]' }}
    needs: ["prepare"]
    name: Build ${{ matrix.container }}
    uses: ./.github/workflows/build-containers.yaml
    permissions:
      contents: read
      packages: read
    secrets: inherit
    strategy:
      matrix:
        container: ${{ fromJSON(needs.prepare.outputs.changed-containers) }}
      fail-fast: false
      max-parallel: 4
    with:
      container: ${{ matrix.container }}
      path: .github/containers
